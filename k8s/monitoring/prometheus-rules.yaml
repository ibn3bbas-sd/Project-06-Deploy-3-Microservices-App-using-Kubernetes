apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: microservices-alerts
  namespace: monitoring
  labels:
    release: prometheus
spec:
  groups:
  - name: api-service-alerts
    interval: 30s
    rules:
    # High CPU Usage
    - alert: APIServiceHighCPU
      expr: |
        rate(container_cpu_usage_seconds_total{namespace="api-service",pod=~"api-service-.*"}[5m]) > 0.8
      for: 5m
      labels:
        severity: warning
        service: api-service
      annotations:
        summary: "API Service high CPU usage"
        description: "API Service pod {{ $labels.pod }} CPU usage is above 80% (current: {{ $value | humanizePercentage }})"
    
    # High Memory Usage
    - alert: APIServiceHighMemory
      expr: |
        container_memory_usage_bytes{namespace="api-service",pod=~"api-service-.*"} / 
        container_spec_memory_limit_bytes{namespace="api-service",pod=~"api-service-.*"} > 0.9
      for: 5m
      labels:
        severity: warning
        service: api-service
      annotations:
        summary: "API Service high memory usage"
        description: "API Service pod {{ $labels.pod }} memory usage is above 90%"
    
    # Pod Down
    - alert: APIServicePodDown
      expr: |
        kube_deployment_status_replicas_available{namespace="api-service",deployment="api-service"} < 2
      for: 2m
      labels:
        severity: critical
        service: api-service
      annotations:
        summary: "API Service has less than 2 pods running"
        description: "Only {{ $value }} API Service pods are available"
    
    # High Error Rate
    - alert: APIServiceHighErrorRate
      expr: |
        rate(http_requests_total{namespace="api-service",status_code=~"5.."}[5m]) / 
        rate(http_requests_total{namespace="api-service"}[5m]) > 0.05
      for: 5m
      labels:
        severity: critical
        service: api-service
      annotations:
        summary: "API Service high error rate"
        description: "Error rate is {{ $value | humanizePercentage }} (threshold: 5%)"
    
    # Slow Response Time
    - alert: APIServiceSlowResponse
      expr: |
        histogram_quantile(0.95, 
          rate(http_request_duration_seconds_bucket{namespace="api-service"}[5m])
        ) > 2
      for: 5m
      labels:
        severity: warning
        service: api-service
      annotations:
        summary: "API Service slow response time"
        description: "95th percentile response time is {{ $value }}s (threshold: 2s)"

  - name: auth-service-alerts
    interval: 30s
    rules:
    - alert: AuthServicePodDown
      expr: |
        kube_deployment_status_replicas_available{namespace="auth-service",deployment="auth-service"} < 1
      for: 1m
      labels:
        severity: critical
        service: auth-service
      annotations:
        summary: "Auth Service pods down"
        description: "Auth Service has no available pods"
    
    - alert: AuthServiceHighCPU
      expr: |
        rate(container_cpu_usage_seconds_total{namespace="auth-service",pod=~"auth-service-.*"}[5m]) > 0.7
      for: 5m
      labels:
        severity: warning
        service: auth-service
      annotations:
        summary: "Auth Service high CPU usage"
        description: "CPU usage is {{ $value | humanizePercentage }}"

  - name: image-service-alerts
    interval: 30s
    rules:
    - alert: ImageServicePodDown
      expr: |
        kube_deployment_status_replicas_available{namespace="image-service",deployment="image-service"} < 1
      for: 2m
      labels:
        severity: critical
        service: image-service
      annotations:
        summary: "Image Service pods down"
        description: "Image Service has no available pods"
    
    - alert: ImageServiceHighMemory
      expr: |
        container_memory_usage_bytes{namespace="image-service",pod=~"image-service-.*"} / 
        container_spec_memory_limit_bytes{namespace="image-service",pod=~"image-service-.*"} > 0.9
      for: 5m
      labels:
        severity: warning
        service: image-service
      annotations:
        summary: "Image Service high memory usage"
        description: "Memory usage is above 90%"
    
    - alert: ImageServiceS3ConnectionFailed
      expr: |
        up{job="image-service"} == 0
      for: 2m
      labels:
        severity: critical
        service: image-service
      annotations:
        summary: "Image Service cannot connect to S3"
        description: "S3 connection health check failing"